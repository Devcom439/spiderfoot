name: SpiderFoot WebUI Test

on:
  workflow_dispatch:  # run manually
  push:
    branches: [ "master" ]

jobs:
  run-spiderfoot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    - name: Install cloudflared
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
        chmod +x cloudflared

    - name: Start SpiderFoot and tunnel
      run: |
        # Start SpiderFoot in background
        nohup python sf.py -l 127.0.0.1:5001 > spiderfoot.log 2>&1 &
        sleep 10

        # Start Cloudflare tunnel
        echo "Starting tunnel..."
        ./cloudflared tunnel --url http://127.0.0.1:5001 --no-autoupdate > tunnel.log 2>&1 &

        # Wait a few seconds for tunnel URL to appear
        sleep 10

        # Print tunnel URL
        echo "Tunnel started! Fetching public URL:"
        grep -o "https://.*trycloudflare.com" tunnel.log || echo "⚠️ No URL found yet"

        echo "You can open the above URL in your browser to test the SpiderFoot web UI."
        
        # Keep job alive for a while so you can access it
        echo "Keeping runner alive..."
        sleep 4400
